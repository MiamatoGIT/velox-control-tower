<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velox Field Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'], },
                    colors: { velox: { bg: '#050b14', primary: '#00ff9d', dim: 'rgba(0, 255, 157, 0.1)', danger: '#ff3333' } },
                    boxShadow: { 'neon': '0 0 20px rgba(0, 255, 157, 0.4)' },
                    animation: { 'pulse-red': 'pulseRed 1.5s infinite' },
                    keyframes: { 
                        pulseRed: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(255, 0, 0, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(255, 0, 0, 0)' } }
                    },
                    backgroundImage: {
                        'circuit-pattern': "url('data:image/svg+xml,%3Csvg width=\"80\" height=\"80\" viewBox=\"0 0 80 80\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cpath d=\"M0 0h80v80H0z\" fill=\"%23050b14\" fill-opacity=\"0\"/%3E%3Cpath stroke=\"%2300ff9d\" stroke-width=\"0.5\" stroke-opacity=\"0.15\" d=\"M0 40h10l5 5 5-5h10l5 5 5-5h10l5 5 5-5h10M0 20h20l5 5 5-5h20l5 5 5-5h20M0 60h30l5 5 5-5h30M40 0v10l5 5-5 5v10l5 5-5 5v10l5 5-5 5v10M20 0v20l5 5-5 5v20l5 5-5 5v20M60 0v30l5 5-5 5v30\"/%3E%3C/g%3E%3C/svg%3E')",
                        'neon-radial': 'radial-gradient(circle at center, rgba(0, 255, 157, 0.1) 0%, rgba(5, 11, 20, 1) 70%)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050b14; background-image: var(--tw-bg-image-neon-radial), var(--tw-bg-image-circuit-pattern); background-repeat: no-repeat, repeat; background-attachment: fixed; }
        .glass-panel { background-color: rgba(15, 23, 42, 0.65); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .scanline { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.3)); background-size: 100% 4px; pointer-events: none; z-index: 50; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        /* REAL AUDIO BARS */
        .audio-bar { width: 6px; background-color: #00ff9d; border-radius: 9999px; transition: height 0.05s ease; height: 4px; }
    </style>
</head>
<body class="text-white h-screen flex justify-center items-center overflow-hidden">

    <div class="glass-panel w-full h-full max-w-md flex flex-col relative shadow-2xl sm:h-[90vh] sm:border-2 sm:border-slate-700/50 sm:rounded-[3rem] overflow-hidden">
        <div class="scanline opacity-20 absolute inset-0"></div>

        <div class="pt-10 pb-4 px-6 bg-gradient-to-b from-slate-900/80 to-transparent z-10">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div id="conn-dot" class="w-2 h-2 rounded-full bg-velox-primary animate-pulse"></div>
                    <span id="conn-text" class="text-xs font-mono text-velox-primary tracking-widest">CONNECTED</span>
                </div>
                <div class="relative">
                    <select id="langSelect" onchange="changeLanguage()" class="bg-slate-900/80 border border-velox-primary/50 text-velox-primary text-xs font-mono py-1 pl-3 pr-6 rounded uppercase focus:outline-none focus:shadow-neon cursor-pointer">
                        <option value="en" selected>English</option>
                        <option value="no">Norsk</option>
                        <option value="pl">Polski</option>
                        <option value="pt">Português</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                    </select>
                </div>
            </div>

            <div class="border border-slate-700/80 bg-slate-900/40 p-3 rounded-lg">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1 font-bold">Active Work Package</div>
                <div class="font-mono text-sm text-white font-bold tracking-tight flex items-center gap-2 truncate">
                    <svg class="w-4 h-4 text-velox-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    KSB1-CTS-B1-XX-DR-E-60201
                </div>
            </div>
            
            <div class="w-full bg-slate-800/50 h-1 mt-6 rounded-full overflow-hidden">
                <div id="progBar" class="bg-velox-primary h-full w-1/4 shadow-neon transition-all duration-500"></div>
            </div>
        </div>

        <div class="flex-1 relative p-6 flex flex-col justify-center z-20">

            <div id="step1" class="screen active flex flex-col h-full justify-center gap-6">
                <div class="text-center mb-8">
                    <h2 id="txt-task" class="text-3xl font-bold font-sans tracking-tight mb-2">Task Complete?</h2>
                    <p id="txt-verify" class="text-slate-400 text-sm">Verify physical installation against schematic.</p>
                </div>
                <button onclick="setTaskStatus('YES')" class="relative group w-full h-32 bg-velox-dim/50 border border-velox-primary/80 rounded-2xl flex flex-col items-center justify-center transition-all active:scale-95 hover:shadow-neon hover:bg-velox-dim">
                    <span id="btn-yes" class="text-4xl font-bold text-velox-primary mb-1 drop-shadow-[0_0_10px_rgba(0,255,157,0.4)]">YES</span>
                </button>
                <button onclick="setTaskStatus('NO')" class="w-full h-20 border border-slate-700/80 bg-slate-900/30 rounded-2xl flex items-center justify-center gap-3 text-slate-400 hover:border-velox-danger/80 hover:text-velox-danger transition-all active:scale-95">
                    <span id="btn-no" class="text-xl font-bold">NO</span>
                </button>
            </div>

            <div id="step2" class="screen hidden flex-col h-full justify-between py-6">
                <div class="text-center">
                    <h3 id="txt-qty-head" class="text-xl font-mono text-velox-primary mb-2">INPUT_QUANTITY</h3>
                    <p id="txt-qty-sub" class="text-slate-400 text-sm">How many meters installed?</p>
                </div>

                <div id="listen-indicator" class="hidden text-center text-xs text-velox-primary animate-pulse mb-2">● LISTENING...</div>

                <div id="audio-viz-1" class="flex justify-center items-end h-16 gap-1 opacity-80 my-4">
                    <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                </div>

                <div class="relative flex justify-center">
                    <button onclick="recordVoice('qty')" id="btn-qty" class="w-24 h-24 rounded-full border-2 border-velox-primary bg-slate-900/80 shadow-neon flex items-center justify-center z-10 active:scale-90 transition-transform">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                </div>

                <div id="qtyText" class="text-center font-mono text-3xl text-white mt-6 min-h-[40px] drop-shadow-[0_0_5px_rgba(0,255,157,0.5)]">0</div>
                <button id="btn-next" onclick="nextStep(3)" class="w-full py-4 bg-slate-800/80 border border-slate-600/80 text-white rounded-xl mt-4 font-mono text-sm hover:bg-slate-700/80 transition-colors">NEXT >></button>
            </div>

            <div id="step3" class="screen hidden flex-col h-full justify-between py-6">
                <div class="text-center">
                    <h3 id="txt-log-head" class="text-xl font-mono text-velox-primary mb-2">LOG_EXCEPTION</h3>
                    <p id="txt-log-sub" class="text-slate-400 text-sm">Report delays or issues.</p>
                </div>

                <div id="listen-indicator-2" class="hidden text-center text-xs text-velox-primary animate-pulse mb-2">● LISTENING...</div>
                
                <div id="audio-viz-2" class="flex justify-center items-end h-16 gap-1 opacity-80 my-4">
                     <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                </div>

                <div class="flex-1 flex flex-col justify-center items-center">
                    <button onclick="recordVoice('comment')" id="btn-comment" class="w-20 h-20 rounded-full border border-slate-600/80 bg-slate-900/80 flex items-center justify-center mb-6 active:border-velox-primary active:shadow-neon transition-all">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                    <div id="commentText" class="w-full p-4 bg-slate-900/40 rounded border border-slate-700/80 text-slate-300 font-mono text-sm min-h-[80px] backdrop-blur-sm">...</div>
                </div>
                <button id="btn-review" onclick="showReview()" class="w-full py-4 bg-slate-800/80 border border-slate-600/80 text-white rounded-xl mt-4 font-mono text-sm hover:bg-slate-700/80 transition-colors">REVIEW LOG >></button>
            </div>

            <div id="step4" class="screen hidden flex-col h-full justify-end py-6">
                <div class="bg-slate-900/60 border border-slate-700/80 p-6 rounded-xl space-y-4 mb-6 backdrop-blur-sm">
                    <div class="flex justify-between border-b border-slate-800/50 pb-2">
                        <span class="text-slate-500 font-mono text-xs">STATUS</span>
                        <span id="revStatus" class="text-velox-primary font-bold">--</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-800/50 pb-2">
                        <span class="text-slate-500 font-mono text-xs">QTY</span>
                        <span id="revQty" class="text-white font-mono text-lg">--</span>
                    </div>
                    <div>
                        <span class="text-slate-500 font-mono text-xs block mb-1">TRANSCRIPT</span>
                        <p id="revComment" class="text-slate-400 text-sm italic break-words">--</p>
                    </div>
                </div>
                <button id="btn-submit" onclick="submitFinal()" class="w-full py-5 bg-velox-primary text-black font-bold rounded-xl shadow-neon hover:bg-white transition-colors flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    UPLOAD TO ACC
                </button>
            </div>

            <div id="successScreen" class="screen hidden flex-col h-full justify-center items-center text-center">
                <div class="w-24 h-24 rounded-full border-4 border-velox-primary flex items-center justify-center mb-6 shadow-neon">
                    <svg class="w-10 h-10 text-velox-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h2 class="text-2xl text-white font-bold mb-2">SYNC COMPLETE</h2>
                <div class="text-slate-500 font-mono text-xs mb-8">FILE: KSB1...60201.pdf<br>LOC: ACC / Daily_Reports</div>
                <button onclick="location.reload()" class="px-6 py-2 border border-slate-700/80 text-slate-400 rounded hover:text-white transition-colors">RESTART</button>
            </div>
        </div>
    </div>

    <script>
        const dict = {
            en: { task: "Task Complete?", verify: "Verify physical installation against schematic.", yes: "YES", no: "NO", qtyHead: "INPUT_QUANTITY", qtySub: "How many meters installed?", next: "NEXT >>", logHead: "LOG_EXCEPTION", logSub: "Report delays or issues.", review: "REVIEW LOG >>", submit: "UPLOAD TO ACC", voiceCode: "en-US", fakeQty: "50 Meters", fakeLog: "Material delivery delayed by 2 hours." },
            pl: { task: "Zadanie gotowe?", verify: "Potwierdź instalację zgodnie ze schematem.", yes: "TAK", no: "NIE", qtyHead: "INPUT_QUANTITY", qtySub: "Ile metrów zainstalowano?", next: "DALEJ >>", logHead: "LOG_EXCEPTION", logSub: "Zgłoś opóźnienia lub problemy.", review: "PODSUMOWANIE >>", submit: "WYŚLIJ DO ACC", voiceCode: "pl-PL", fakeQty: "50 Metrów", fakeLog: "Dostawa materiałów opóźniona o 2 godziny." },
            no: { task: "Oppgave fullført?", verify: "Verifiser installasjonen mot skjema.", yes: "JA", no: "NEI", qtyHead: "ANTALL", qtySub: "Hvor mange meter installert?", next: "NESTE >>", logHead: "AVVIK", logSub: "Rapporter forsinkelser eller problemer.", review: "SE OVER >>", submit: "LAST OPP TIL ACC", voiceCode: "no-NO", fakeQty: "50 Meter", fakeLog: "Materiallevering forsinket med 2 timer." },
            pt: { task: "Tarefa Concluída?", verify: "Verificar instalação física.", yes: "SIM", no: "NÃO", qtyHead: "QUANTIDADE", qtySub: "Quantos metros instalados?", next: "PRÓXIMO >>", logHead: "REGISTRO", logSub: "Relatar atrasos ou problemas.", review: "REVISÃO >>", submit: "ENVIAR PARA ACC", voiceCode: "pt-PT", fakeQty: "50 Metros", fakeLog: "Entrega de material atrasada em 2 horas." },
            fr: { task: "Tâche terminée ?", verify: "Vérifier l'installation physique.", yes: "OUI", no: "NON", qtyHead: "QUANTITÉ", qtySub: "Combien de mètres installés ?", next: "SUIVANT >>", logHead: "EXCEPTION", logSub: "Signaler des retards ou problèmes.", review: "RÉVISION >>", submit: "TÉLÉCHARGER VERS ACC", voiceCode: "fr-FR", fakeQty: "50 Mètres", fakeLog: "Livraison de matériel retardée de 2 heures." },
            es: { task: "¿Tarea completa?", verify: "Verificar instalación física.", yes: "SÍ", no: "NO", qtyHead: "CANTIDAD", qtySub: "¿Cuántos metros instalados?", next: "SIGUIENTE >>", logHead: "EXCEPCIÓN", logSub: "Reportar retrasos o problemas.", review: "REVISAR >>", submit: "SUBIR A ACC", voiceCode: "es-ES", fakeQty: "50 Metros", fakeLog: "Entrega de material retrasada 2 horas." }
        };

        let reportData = { taskStatus: "", quantity: "", comments: "", lang: "en" };
        let currentLang = "en";
        let recognition;
        let currentRecordingTarget = '';
        let audioContext, analyser, microphone, javascriptNode;
        let isVisualizerRunning = false;

        function changeLanguage() {
            const val = document.getElementById('langSelect').value;
            currentLang = val;
            reportData.lang = val;
            const t = dict[val];
            document.getElementById('txt-task').innerText = t.task;
            document.getElementById('txt-verify').innerText = t.verify;
            document.getElementById('btn-yes').innerText = t.yes;
            document.getElementById('btn-no').innerText = t.no;
            document.getElementById('txt-qty-head').innerText = t.qtyHead;
            document.getElementById('txt-qty-sub').innerText = t.qtySub;
            document.getElementById('btn-next').innerText = t.next;
            document.getElementById('txt-log-head').innerText = t.logHead;
            document.getElementById('txt-log-sub').innerText = t.logSub;
            document.getElementById('btn-review').innerText = t.review;
            document.getElementById('btn-submit').innerText = t.submit;
            
            // Re-init speech with new lang
            if(recognition) recognition.abort();
            initSpeech();
        }

        function initSpeech() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = dict[currentLang].voiceCode;
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() { toggleUI(true, currentRecordingTarget); };
                recognition.onend = function() { toggleUI(false, currentRecordingTarget); stopVisualizer(); };

                recognition.onresult = function(event) {
                    let txt = event.results[0][0].transcript;
                    if(currentRecordingTarget === 'qty') {
                        document.getElementById('qtyText').innerText = txt;
                        reportData.quantity = txt;
                    } else {
                        document.getElementById('commentText').innerText = txt;
                        reportData.comments = txt;
                    }
                };
                
                recognition.onerror = function(event) {
                    console.log("Mic Error:", event.error);
                    if(event.error === 'no-speech') {
                         // No alert, just silent fail (user can tap again)
                         toggleUI(false, currentRecordingTarget);
                         stopVisualizer();
                    } else {
                         alert("Mic Error: " + event.error);
                    }
                };
            }
        }

        initSpeech();

        // --- REAL AUDIO VISUALIZER LOGIC ---
        function startVisualizer() {
            if (isVisualizerRunning) return;
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
                isVisualizerRunning = true;
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    var array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    var values = 0;
                    var length = array.length;
                    for (var i = 0; i < length; i++) { values += array[i]; }
                    var average = values / length;

                    // Update bars based on volume (average)
                    updateBars(average);
                }
            }).catch(function(err) {
                console.log("Visualizer Error: " + err);
            });
        }

        function stopVisualizer() {
            if(audioContext) audioContext.close();
            isVisualizerRunning = false;
            // Reset bars
            const bars = document.querySelectorAll('.audio-bar');
            bars.forEach(b => b.style.height = '4px');
        }

        function updateBars(volume) {
            // Map volume (0-100 roughly) to height
            const bars = document.querySelectorAll(currentRecordingTarget === 'qty' ? '#audio-viz-1 .audio-bar' : '#audio-viz-2 .audio-bar');
            bars.forEach((bar, index) => {
                // Add some randomness to make it look active
                let height = Math.max(4, (volume * 2) + (Math.random() * 10)); 
                if (volume < 5) height = 4; // Flatline if quiet
                bar.style.height = height + 'px';
            });
        }

        function recordVoice(target) {
            currentRecordingTarget = target;
            try { 
                recognition.abort(); 
                setTimeout(() => {
                    recognition.start();
                    startVisualizer(); 
                }, 100); 
            } 
            catch(e) { console.log(e); }
        }

        function toggleUI(isActive, target) {
            if(target === 'qty') {
                const el = document.getElementById('listen-indicator');
                const btn = document.getElementById('btn-qty');
                const viz = document.getElementById('audio-viz-1');
                if(isActive) { el.classList.remove('hidden'); btn.classList.add('animate-pulse-red'); viz.classList.remove('opacity-80'); }
                else { el.classList.add('hidden'); btn.classList.remove('animate-pulse-red'); viz.classList.add('opacity-80'); }
            } else {
                const el = document.getElementById('listen-indicator-2');
                const btn = document.getElementById('btn-comment');
                const viz = document.getElementById('audio-viz-2');
                if(isActive) { el.classList.remove('hidden'); btn.classList.add('animate-pulse-red'); viz.classList.remove('opacity-80'); }
                else { el.classList.add('hidden'); btn.classList.remove('animate-pulse-red'); viz.classList.add('opacity-80'); }
            }
        }

        function setTaskStatus(status) { reportData.taskStatus = status; nextStep(2); }
        function nextStep(stepNum) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.add('hidden'); s.classList.remove('active'); });
            const next = document.getElementById('step' + stepNum);
            next.classList.remove('hidden'); next.classList.add('active');
            document.getElementById('progBar').style.width = (stepNum * 25) + '%';
        }
        function showReview() {
            document.getElementById('revStatus').innerText = reportData.taskStatus;
            document.getElementById('revQty').innerText = reportData.quantity || "0";
            document.getElementById('revComment').innerText = reportData.comments || "None";
            nextStep(4);
        }
        function submitFinal() {
            fetch('/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(reportData)
            })
            .then(res => res.json())
            .then(data => {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('successScreen').classList.remove('hidden');
                document.getElementById('successScreen').classList.add('flex');
            });
        }
    </script>
</body>
</html>